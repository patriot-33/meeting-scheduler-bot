# Спецификация исправлений от 31.07.2025

## Исправленные проблемы

### 1. ❌ Критическая ошибка: отсутствие колонки google_calendar_id
**Проблема**: При бронировании встречи возникала ошибка `column meetings.google_calendar_id does not exist`

**Причина**: В методе `_ensure_missing_fields_exist()` использовался неправильный доступ к атрибутам (`col.name` вместо `col['name']`)

**Решение**: 
- Исправлен доступ к атрибутам в `database.py:231`
- Теперь миграция корректно применяется при инициализации БД

### 2. ✅ Добавлена команда проверки OAuth статуса
**Новая функциональность**: `/check_oauth`

**Возможности**:
- Показывает статус OAuth подключения для любого пользователя
- Отображает email, Google Calendar ID, статус подключения
- Для владельцев показывает общую статистику системы
- Дает рекомендации по настройке, если календарь не подключен

### 3. ✅ Встречи создаются в календарях обоих участников
**Проблема**: Встречи создавались только в календаре владельца

**Решение**: 
- Создан новый сервис `DualCalendarCreator` 
- Теперь встречи создаются и в календаре руководителя, и в календаре владельца
- Google Meet ссылка создается один раз и используется в обеих встречах
- Участники добавляются как optional attendees

### 4. ✅ Google Meet автоматически добавляется во встречи
**Функциональность**:
- При создании встречи автоматически генерируется Google Meet ссылка
- Если создание Meet не удается, встреча создается без нее
- Ссылка сохраняется в БД и отправляется участникам

### 5. ✅ Добавлена команда /calendar_instructions
**Новый alias**: `/calendar_instructions` = `/calendar_simple`

**Назначение**: Более интуитивное название для получения инструкций по подключению календаря

## Технические детали

### Измененные файлы:
1. `src/database.py` - исправлен доступ к атрибутам колонок
2. `src/handlers/check_oauth_status.py` - новый handler для проверки OAuth
3. `src/services/google_calendar_dual.py` - новый сервис для создания встреч в двух календарях  
4. `src/services/meeting_service.py` - интеграция dual calendar creator
5. `src/main.py` - добавлены новые handlers

### Новые команды:
- `/check_oauth` - проверка статуса OAuth подключения
- `/calendar_instructions` - инструкции по подключению календаря (alias для /calendar_simple)

## Рекомендации по деплою

1. После деплоя убедитесь, что миграция `add_google_calendar_id_field.py` применилась корректно
2. Проверьте логи на наличие сообщения: "✅ Поле google_calendar_id в meetings успешно добавлено"
3. Протестируйте создание встречи через команду `/schedule`
4. Проверьте, что встречи появляются в календарях обоих участников

## Статус: ✅ Все проблемы исправлены